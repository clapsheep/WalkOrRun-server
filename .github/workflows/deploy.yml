name: Deploy to Amazon ECR

on:
 push:
   branches: [ "main" ]
 pull_request:
   branches: [ "main" ]
   types: [opened, synchronize]

# 동시 실행 방지
concurrency:
 group: ${{ github.workflow }}-${{ github.ref }}
 cancel-in-progress: true

env:
 AWS_REGION: ap-northeast-2
 ECR_REPOSITORY: running-server
 
jobs:
 deploy:
   name: Deploy
   runs-on: ubuntu-latest
   environment: 
     name: production
     url: http://${{ secrets.AWS_EC2_HOST }}:8080

   steps:
   - name: Checkout
     uses: actions/checkout@v3

   - name: Set up JDK 17
     uses: actions/setup-java@v3
     with:
       java-version: '17'
       distribution: 'temurin'

   - name: Cache Gradle packages
     uses: actions/cache@v3
     if: github.event_name == 'push'
     with:
       path: |
         ~/.gradle/caches
         ~/.gradle/wrapper
       key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
       restore-keys: |
         ${{ runner.os }}-gradle-
       save-always: false
       upload-chunk-size: 32768

   - name: Validate Gradle wrapper
     uses: gradle/wrapper-validation-action@v1

   - name: Build with Gradle
     uses: gradle/gradle-build-action@v2
     with:
       arguments: build --no-daemon --parallel
       gradle-home-cache-cleanup: true

   - name: Configure AWS credentials
     uses: aws-actions/configure-aws-credentials@v1
     with:
       aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
       aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
       aws-region: ${{ env.AWS_REGION }}

   - name: Login to Amazon ECR
     id: login-ecr
     uses: aws-actions/amazon-ecr-login@v1

   - name: Build, tag, and push image to Amazon ECR
     id: build-image
     env:
       ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
       IMAGE_TAG: latest
     run: |
       docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
       docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

   - name: Deploy to EC2
     uses: appleboy/ssh-action@v1.0.0
     with:
       host: ${{ secrets.AWS_EC2_HOST }}
       username: ${{ secrets.AWS_EC2_USERNAME }}
       key: ${{ secrets.AWS_EC2_SSH_KEY }}
       port: 22
       script_stop: true
       debug: true
       timeout: 60s
       command_timeout: 20m
       script: |
         echo "Starting deployment..."
         aws ecr get-login-password --region ${{ env.AWS_REGION }} | docker login --username AWS --password-stdin ${{ steps.login-ecr.outputs.registry }}
         echo "Logged in to ECR"
         cd ~/running-project
         echo "Changed directory"
         echo "Cleaning up existing containers..."
         docker compose down --remove-orphans
         docker rm -f mysql springboot-app || true
         docker network rm running-project_app_network || true
         echo "Cleaned up existing containers"
         docker pull ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:latest
         echo "Pulled new image"
         docker compose up -d
         echo "Deployment complete"

   - name: Clean up Gradle Cache
     run: |
       rm -f ~/.gradle/caches/modules-2/modules-2.lock
       rm -f ~/.gradle/caches/modules-2/gc.properties
